<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVE Factory: Standalone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap');
        
        body { font-family: 'Rajdhani', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .eve-input { background-color: #161b22; border: 1px solid #30363d; color: #58a6ff; font-family: 'Roboto Mono', monospace; transition: all 0.2s; }
        .eve-input:focus { outline: none; border-color: #58a6ff; box-shadow: 0 0 5px rgba(88, 166, 255, 0.3); }
        .eve-card { background: linear-gradient(145deg, #161b22 0%, #0d1117 100%); border: 1px solid #30363d; }
        .stat-value { font-family: 'Roboto Mono', monospace; }
        .btn-action { transition: all 0.2s; }
        .btn-action:hover { transform: translateY(-1px); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #58a6ff; }
        
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-saved { background-color: #2ea043; }
        .status-saving { background-color: #e3b341; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Tab Styles */
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #58a6ff; color: white; }

        /* FIX: Dropdown readability in dark mode */
        #blueprintSelector option {
            background-color: #1f2937;
            color: white;
        }
        
        /* Table row hover effect for Summary */
        .summary-row:hover { background-color: rgba(255,255,255,0.05); }
        
        /* Chart container */
        .chart-container { height: 200px; position: relative; }
        
        /* Tag styling */
        .tag { background: rgba(88, 166, 255, 0.1); border: 1px solid rgba(88, 166, 255, 0.3); }
        
        /* Advanced mode toggle */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #30363d; transition: .4s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #58a6ff; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
        
        /* Sorting arrows */
        .sortable { cursor: pointer; }
        .sortable:hover { color: #58a6ff; }
        .sort-arrow { margin-left: 4px; font-size: 0.8em; }
        
        /* CSV import styling */
        .csv-preview { max-height: 300px; overflow-y: auto; }
        .csv-row { border-bottom: 1px solid #30363d; }
        .csv-row:hover { background: rgba(88, 166, 255, 0.1); }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 pb-20">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-6 flex flex-col md:flex-row items-center justify-between border-b border-gray-700 pb-4 gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="w-12 h-12 bg-blue-900/30 rounded flex items-center justify-center border border-blue-500/50">
                    <i class="fa-solid fa-industry text-2xl text-blue-400"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white tracking-wide">EVE FACTORY</h1>
                    <div class="flex items-center text-xs font-mono uppercase tracking-widest text-gray-400 mt-1">
                        <span id="statusIndicator" class="status-dot status-saved"></span>
                        <span id="statusText" class="text-gray-400 text-xs font-mono uppercase tracking-widest">Guardado Local</span>
                    </div>
                </div>
            </div>

            <!-- Data Management Toolbar -->
            <div class="flex flex-wrap gap-2">
                 <button onclick="exportData()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 border border-gray-600 px-3 py-2 rounded text-sm btn-action flex items-center gap-2" title="Guardar solo los datos (.json)">
                    <i class="fa-solid fa-file-export"></i> <span class="hidden sm:inline">JSON</span>
                </button>
                
                <label class="bg-gray-800 hover:bg-gray-700 text-gray-300 border border-gray-600 px-3 py-2 rounded text-sm btn-action flex items-center gap-2 cursor-pointer" title="Cargar datos (.json)">
                    <i class="fa-solid fa-file-import"></i> <span class="hidden sm:inline">Cargar JSON</span>
                    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importData(this)">
                </label>

                <button onclick="downloadFullApp()" class="bg-blue-600 hover:bg-blue-500 text-white border border-blue-400 px-3 py-2 rounded text-sm btn-action flex items-center gap-2 shadow-lg shadow-blue-900/50 ml-2">
                    <i class="fa-solid fa-download"></i> <span class="font-bold">Guardar Todo (.html)</span>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex gap-6 mb-6 border-b border-gray-800 text-sm font-bold uppercase tracking-wider overflow-x-auto">
            <button onclick="switchView('calculator')" id="tab-calculator" class="tab-btn active pb-2 text-gray-400 hover:text-white transition whitespace-nowrap">
                <i class="fa-solid fa-calculator mr-2"></i> Calculadora
            </button>
            <button onclick="switchView('prices')" id="tab-prices" class="tab-btn pb-2 text-gray-400 hover:text-white transition whitespace-nowrap">
                <i class="fa-solid fa-coins mr-2"></i> Gestión de Precios
            </button>
            <button onclick="switchView('summary')" id="tab-summary" class="tab-btn pb-2 text-gray-400 hover:text-white transition whitespace-nowrap">
                <i class="fa-solid fa-list-check mr-2"></i> Resumen
            </button>
        </div>

        <!-- VIEW: CALCULATOR -->
        <div id="view-calculator" class="transition-opacity duration-300">
            <!-- Blueprint Selector Bar -->
            <div class="flex items-center gap-2 w-full bg-gray-800/50 p-3 rounded-lg border border-gray-700 mb-6">
                <span class="text-gray-400 text-sm font-bold ml-2">PLANO ACTIVO:</span>
                <select id="blueprintSelector" onchange="switchBlueprint(this.value)" class="bg-gray-800 text-white font-bold outline-none flex-grow cursor-pointer text-lg p-1 rounded border border-gray-700/50 focus:border-blue-500"></select>
                <div class="h-6 w-px bg-gray-600 mx-2"></div>
                <button onclick="createNewBlueprint()" class="text-blue-400 hover:text-white px-2 py-1 rounded text-sm btn-action" title="Crear Nuevo">
                    <i class="fa-solid fa-plus fa-lg"></i>
                </button>
                <button onclick="deleteCurrentBlueprint()" class="text-red-500 hover:text-white px-2 py-1 rounded text-sm btn-action" title="Borrar Actual">
                    <i class="fa-solid fa-trash fa-lg"></i>
                </button>
            </div>

            <!-- Advanced Mode Toggle -->
            <div class="flex items-center justify-end gap-2 mb-4">
                <span class="text-xs text-gray-400">Modo Avanzado</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="advancedModeToggle" onchange="toggleAdvancedMode()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <!-- LEFT COLUMN: Settings & Inputs -->
                <div class="lg:col-span-4 space-y-6">
                    
                    <!-- Blueprint Details -->
                    <div class="eve-card rounded-lg p-5 shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-blue-500/5 rounded-bl-full -mr-8 -mt-8 pointer-events-none"></div>
                        <h2 class="text-lg font-bold text-white mb-4 flex items-center border-b border-gray-700 pb-2">
                            <i class="fa-solid fa-sliders mr-2 text-gray-400"></i> Configuración BPO
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1 uppercase">ME Level</label>
                                    <input type="number" id="meLevel" min="0" max="10" class="eve-input w-full rounded p-2 text-center font-bold text-lg" oninput="triggerSave()">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1 uppercase">Output (Yield)</label>
                                    <input type="number" id="baseYield" min="1" class="eve-input w-full rounded p-2 text-center font-bold text-lg" oninput="triggerSave()">
                                    <p class="text-[10px] text-gray-500 text-center mt-1">Unidades por Run</p>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs text-gray-400 mb-1 uppercase">Estructura / Rig Bonus (%)</label>
                                <input type="number" id="structureBonus" min="0" max="100" step="0.1" class="eve-input w-full rounded p-2 text-right font-bold" oninput="triggerSave()">
                                <p class="text-xs text-gray-600 mt-1">Dejar en 0 si no tienes bonus</p>
                            </div>

                            <div>
                                <label class="block text-xs text-gray-400 mb-1 uppercase">Coste Instalación (Job Cost)</label>
                                <input type="number" id="installCost" min="0" class="eve-input w-full rounded p-2 text-right font-bold text-yellow-500" oninput="triggerSave()">
                            </div>

                            <!-- Tags Input -->
                            <div>
                                <label class="block text-xs text-gray-400 mb-1 uppercase">Etiquetas</label>
                                <input type="text" id="tags" placeholder="Separadas por comas (ej: ammo, small)" class="eve-input w-full rounded p-2" oninput="triggerSave()">
                                <p class="text-xs text-gray-600 mt-1">Para organizar/filtrar en el resumen</p>
                            </div>

                            <div class="pt-4 border-t border-gray-700">
                                 <label class="block text-xs text-gray-400 mb-1 uppercase">Runs Totales</label>
                                <input type="number" id="jobRuns" min="1" value="1" class="eve-input w-full rounded p-2 text-right font-bold text-white bg-blue-900/20 border-blue-500/30" oninput="triggerSave()">
                            </div>
                        </div>
                    </div>

                    <!-- Market Settings -->
                    <div class="eve-card rounded-lg p-5 shadow-lg">
                        <h2 class="text-lg font-bold text-white mb-4 flex items-center border-b border-gray-700 pb-2">
                            <i class="fa-solid fa-shop mr-2 text-gray-400"></i> Mercado (Venta)
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1 uppercase">Precio Venta Unitario</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-500">ISK</span>
                                    <input type="number" id="sellPrice" step="0.01" class="eve-input w-full rounded p-2 pl-10 text-right font-bold text-green-400" oninput="triggerSave()">
                                </div>
                            </div>
                            
                             <div class="flex items-center justify-between gap-4">
                                 <div class="w-1/2">
                                    <label class="block text-xs text-gray-400 mb-1 uppercase">Impuestos %</label>
                                    <input type="number" id="salesTax" value="3.6" step="0.1" class="eve-input w-full rounded p-2 text-right font-bold" oninput="triggerSave()">
                                 </div>
                                 <div class="w-1/2 text-right pt-4">
                                     <p class="text-xs text-gray-500">Neto tras impuestos</p>
                                     <p id="netSellPriceDisplay" class="font-mono text-sm text-gray-300">0.00</p>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CENTER/RIGHT COLUMN: Materials & Results -->
                <div class="lg:col-span-8 space-y-6">
                    
                    <!-- Materials Editor -->
                    <div class="eve-card rounded-lg p-5 shadow-lg min-h-[400px]">
                         <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-white flex items-center">
                                    <i class="fa-solid fa-cubes mr-2 text-gray-400"></i> Materiales
                                </h2>
                                <p class="text-xs text-gray-500">Define los materiales para 1 Run.</p>
                            </div>
                            
                            <!-- Add Material Form WITH DATALIST -->
                            <div class="flex gap-2 w-full md:w-auto bg-gray-900/50 p-2 rounded border border-gray-700">
                                <input type="text" id="newMatName" list="materialSuggestions" placeholder="Nombre (ej: Tritanium)" class="eve-input w-full md:w-32 px-2 py-1 text-sm rounded">
                                <!-- Datalist for autocomplete -->
                                <datalist id="materialSuggestions"></datalist>
                                
                                <input type="number" id="newMatQty" placeholder="Cant." class="eve-input w-20 px-2 py-1 text-sm rounded">
                                <button onclick="addMaterialFromInput()" class="bg-green-600 hover:bg-green-500 text-white px-3 rounded btn-action">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Materials Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead>
                                    <tr class="text-gray-500 border-b border-gray-700 text-xs uppercase tracking-wider">
                                        <th class="pb-2 pl-2">Material</th>
                                        <th class="pb-2 text-center w-24">Base Qty</th>
                                        <th class="pb-2 text-center w-24">Req. (ME)</th>
                                        <th class="pb-2 text-right w-32">Precio (Jita)</th>
                                        <th class="pb-2 text-right w-32">Coste</th>
                                        <th class="pb-2 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="materialsTable" class="divide-y divide-gray-800">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Advanced Materials Breakdown (Hidden by default) -->
                        <div id="advancedBreakdown" class="hidden mt-6 border-t border-gray-700 pt-4">
                            <h3 class="text-lg font-bold text-white mb-3">Desglose Detallado (Total Job)</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-xs">
                                    <thead>
                                        <tr class="text-gray-500 border-b border-gray-700 uppercase tracking-wider">
                                            <th class="pb-2 pl-2">Material</th>
                                            <th class="pb-2 text-center">Total Base</th>
                                            <th class="pb-2 text-center">Mod ME</th>
                                            <th class="pb-2 text-center">Mod Estr.</th>
                                            <th class="pb-2 text-center">Total Final</th>
                                            <th class="pb-2 text-center">Ahorro</th>
                                            <th class="pb-2 text-right">Coste Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailedBreakdownTable" class="divide-y divide-gray-800">
                                        <!-- Rendered by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end items-center border-t border-gray-700 pt-4">
                             <div class="text-right">
                                 <span class="text-gray-400 text-sm uppercase mr-2">Coste Total Materiales:</span>
                                 <span class="text-xl font-bold stat-value text-blue-400" id="totalMatCost">0.00</span>
                             </div>
                        </div>
                    </div>

                    <!-- FINAL RESULTS -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        
                        <!-- Cost Box -->
                        <div class="eve-card rounded-lg p-4 border-t-4 border-t-red-500 bg-gray-900/50">
                            <h3 class="text-gray-400 text-xs uppercase mb-1">Coste Unitario</h3>
                            <div class="text-2xl font-bold text-white stat-value truncate" id="costPerUnit">0.00</div>
                            <div class="text-[10px] text-gray-500">Materiales + Instalación</div>
                        </div>

                        <!-- Profit Box -->
                        <div class="eve-card rounded-lg p-4 border-t-4 border-t-green-500 bg-gray-900/50">
                            <h3 class="text-gray-400 text-xs uppercase mb-1">Beneficio Unitario</h3>
                            <div class="text-2xl font-bold stat-value truncate text-gray-500" id="profitPerUnit">0.00</div>
                            <div class="text-[10px] text-gray-500">Margen: <span id="marginPercent">0%</span></div>
                        </div>

                        <!-- Total Job Box -->
                        <div class="eve-card rounded-lg p-4 border-t-4 border-t-blue-500 bg-gray-900/50">
                            <h3 class="text-gray-400 text-xs uppercase mb-1">Beneficio Total Job</h3>
                            <div class="text-2xl font-bold stat-value truncate text-gray-500" id="totalJobProfit">0.00</div>
                            <div class="text-[10px] text-gray-500">Para <span id="displayTotalRuns">1</span> runs</div>
                        </div>

                    </div>

                    <!-- Margin Trend Chart (Hidden by default) -->
                    <div id="marginChartContainer" class="hidden eve-card rounded-lg p-5 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-white flex items-center">
                                <i class="fa-solid fa-chart-line mr-2 text-gray-400"></i> Tendencia de Márgenes
                            </h2>
                            <button onclick="addCurrentMarginToHistory()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded">
                                <i class="fa-solid fa-plus mr-1"></i> Guardar Punto
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="marginChart"></canvas>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            Historial de márgenes para este blueprint
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- VIEW: PRICE LIST -->
        <div id="view-prices" class="hidden">
            <div class="eve-card rounded-lg p-5 shadow-lg max-w-4xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center mb-2">
                        <i class="fa-solid fa-coins mr-2 text-gray-400"></i> Listado Global de Materiales
                    </h2>
                    <p class="text-sm text-gray-400">Edita aquí los precios de todos los materiales utilizados en tus blueprints. Los cambios se aplicarán automáticamente a todos los cálculos.</p>
                </div>

                <!-- CSV Import Section -->
                <div class="mb-6 p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <h3 class="text-md font-bold text-white mb-2">Importar Precios desde CSV</h3>
                    <div class="flex flex-col md:flex-row gap-2 items-center">
                        <label class="bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 px-4 py-2 rounded text-sm btn-action flex items-center gap-2 cursor-pointer">
                            <i class="fa-solid fa-file-csv"></i> Seleccionar CSV
                            <input type="file" id="csvImport" class="hidden" accept=".csv" onchange="previewCSV(this)">
                        </label>
                        <span class="text-xs text-gray-400">Formato: material,precio (ej: Tritanium,6.25)</span>
                    </div>
                    
                    <!-- CSV Preview -->
                    <div id="csvPreview" class="hidden mt-4">
                        <h4 class="text-sm font-bold text-white mb-2">Vista Previa:</h4>
                        <div id="csvPreviewContent" class="csv-preview bg-gray-900/50 rounded p-3 text-xs"></div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="importCSVData()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded text-sm">
                                <i class="fa-solid fa-check mr-2"></i> Importar
                            </button>
                            <button onclick="cancelCSVImport()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded text-sm">
                                <i class="fa-solid fa-times mr-2"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Price Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-800 text-gray-400 uppercase text-xs font-bold">
                            <tr>
                                <th class="p-3">Nombre del Material</th>
                                <th class="p-3 text-right">Precio Actual (ISK)</th>
                                <th class="p-3 text-right">Usado en (BPs)</th>
                            </tr>
                        </thead>
                        <tbody id="globalPriceTable" class="divide-y divide-gray-700">
                            <!-- Rendered JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Export Buttons -->
                <div class="mt-6 flex justify-between border-t border-gray-700 pt-4">
                    <button onclick="exportPriceListToTxt()" class="bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 px-4 py-2 rounded text-sm btn-action flex items-center gap-2">
                        <i class="fa-solid fa-file-lines"></i> Copiar Nombres (.txt)
                    </button>
                    <button onclick="copyMaterialsToClipboard()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm btn-action flex items-center gap-2">
                        <i class="fa-solid fa-copy"></i> Copiar Nombres al Portapapeles
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: SUMMARY -->
        <div id="view-summary" class="hidden">
            <div class="eve-card rounded-lg p-5 shadow-lg max-w-5xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center mb-2">
                        <i class="fa-solid fa-list-check mr-2 text-gray-400"></i> Resumen de Rentabilidad
                    </h2>
                    <div class="flex flex-col md:flex-row justify-between gap-4">
                        <p class="text-sm text-gray-400">Comparativa rápida de todos tus blueprints. Haz clic en el nombre para cargar la calculadora.</p>
                        
                        <!-- Filter by Tags -->
                        <div class="flex gap-2 items-center">
                            <span class="text-xs text-gray-400 whitespace-nowrap">Filtrar por etiqueta:</span>
                            <select id="tagFilter" onchange="filterSummaryByTag()" class="eve-input text-sm px-2 py-1 rounded w-32">
                                <option value="">Todas</option>
                                <!-- Tags will be populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-800 text-gray-400 uppercase text-xs font-bold">
                            <tr>
                                <th class="p-3 sortable" onclick="sortSummary('name')">
                                    Blueprint (Producto) 
                                    <span id="sort-icon-name" class="sort-arrow"></span>
                                </th>
                                <th class="p-3 text-right sortable" onclick="sortSummary('tags')">
                                    Etiquetas
                                    <span id="sort-icon-tags" class="sort-arrow"></span>
                                </th>
                                <th class="p-3 text-right sortable" onclick="sortSummary('cost')">
                                    Coste/Ud
                                    <span id="sort-icon-cost" class="sort-arrow"></span>
                                </th>
                                <th class="p-3 text-right sortable" onclick="sortSummary('price')">
                                    Precio Venta
                                    <span id="sort-icon-price" class="sort-arrow"></span>
                                </th>
                                <th class="p-3 text-right sortable" onclick="sortSummary('profit')">
                                    Beneficio/Ud
                                    <span id="sort-icon-profit" class="sort-arrow"></span>
                                </th>
                                <th class="p-3 text-right sortable" onclick="sortSummary('margin')">
                                    Margen
                                    <span id="sort-icon-margin" class="sort-arrow"></span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="summaryTable" class="divide-y divide-gray-700">
                            <!-- Rendered JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <footer class="mt-12 text-center text-xs text-gray-600 border-t border-gray-800 pt-4 pb-8">
            <p>100% Local. Sin conexiones a internet. Usa "Guardar Todo (.html)" para conservar tus datos de forma segura.</p>
        </footer>
    </div>

    <!-- Chart.js for trend chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- GLOBAL STATE ---
        // -- DATA_MARKER_START --
        window.appState = {
            "currentId": "antimatter_m",
            "tax": 3.6,
            "advancedMode": false,
            "marginHistory": {}, // Store margin history per blueprint
            "blueprints": [
                {
                    "id": "antimatter_m",
                    "name": "Antimatter Charge M",
                    "yield": 100,
                    "me": 10,
                    "structure": 0,
                    "installCost": 500,
                    "sellPrice": 25,
                    "tags": ["ammo", "hybrid", "medium"],
                    "materials": [
                        { "name": "Tritanium", "qty": 449 },
                        { "name": "Pyerite", "qty": 417 },
                        { "name": "Mexallon", "qty": 7 }
                    ]
                }
            ],
            "prices": {
                "Tritanium": 6,
                "Pyerite": 10,
                "Mexallon": 110
            },
            "lockedPrices": {}
        };
        // -- DATA_MARKER_END --

        let saveTimeout;
        let currentCSVData = null;
        let summarySort = { field: 'name', ascending: true };
        let marginChart = null;

        // --- INIT ---
        function initApp() {
            const saved = localStorage.getItem('eve_factory_local');
            if (saved) {
                try {
                    const loaded = JSON.parse(saved);
                    window.appState = { ...window.appState, ...loaded };
                } catch(e) { console.error("Error loading local save"); }
            }
            // Ensure data structures exist
            if (!window.appState.lockedPrices) window.appState.lockedPrices = {};
            if (!window.appState.marginHistory) window.appState.marginHistory = {};
            
            // Ensure tags exist for all blueprints
            window.appState.blueprints.forEach(bp => {
                if (!bp.tags) bp.tags = [];
            });

            renderApp();
            loadCurrentBlueprintInUI();
            updateMaterialDatalist();
            updateStatus('saved');
            
            // Set advanced mode toggle
            const advToggle = document.getElementById('advancedModeToggle');
            if(advToggle) {
                advToggle.checked = window.appState.advancedMode || false;
                if (window.appState.advancedMode) {
                    document.getElementById('advancedBreakdown').classList.remove('hidden');
                    document.getElementById('marginChartContainer').classList.remove('hidden');
                    // Safety check for chart.js loading
                    if(typeof Chart !== 'undefined') {
                        initMarginChart();
                    }
                }
            }
        }

        // --- NAVIGATION LOGIC ---
        window.switchView = (viewName) => {
            const calcView = document.getElementById('view-calculator');
            const priceView = document.getElementById('view-prices');
            const summaryView = document.getElementById('view-summary');
            
            const tabCalc = document.getElementById('tab-calculator');
            const tabPrice = document.getElementById('tab-prices');
            const tabSum = document.getElementById('tab-summary');

            // Hide all
            calcView.classList.add('hidden');
            priceView.classList.add('hidden');
            summaryView.classList.add('hidden');
            
            // Deactivate tabs
            tabCalc.classList.remove('active');
            tabPrice.classList.remove('active');
            tabSum.classList.remove('active');

            // Show selected
            if (viewName === 'calculator') {
                calcView.classList.remove('hidden');
                tabCalc.classList.add('active');
                loadCurrentBlueprintInUI();
            } else if (viewName === 'prices') {
                priceView.classList.remove('hidden');
                tabPrice.classList.add('active');
                renderPriceList();
            } else if (viewName === 'summary') {
                summaryView.classList.remove('hidden');
                tabSum.classList.add('active');
                renderSummaryTable();
                updateTagFilter();
            }
        };

        // --- ADVANCED MODE ---
        window.toggleAdvancedMode = () => {
            window.appState.advancedMode = !window.appState.advancedMode;
            const advancedSection = document.getElementById('advancedBreakdown');
            const chartSection = document.getElementById('marginChartContainer');
            
            if (window.appState.advancedMode) {
                advancedSection.classList.remove('hidden');
                chartSection.classList.remove('hidden');
                renderDetailedBreakdown();
                if(typeof Chart !== 'undefined') initMarginChart();
            } else {
                advancedSection.classList.add('hidden');
                chartSection.classList.add('hidden');
                if (marginChart) {
                    marginChart.destroy();
                    marginChart = null;
                }
            }
            triggerSave();
        };

        // --- MARGIN HISTORY & CHART ---
        window.addCurrentMarginToHistory = () => {
            const bp = getCurrentBP();
            if (!bp) return;
            
            const stats = getBlueprintStats(bp);
            const now = new Date();
            const timestamp = now.toISOString();
            
            if (!window.appState.marginHistory[bp.id]) {
                window.appState.marginHistory[bp.id] = [];
            }
            
            window.appState.marginHistory[bp.id].push({
                timestamp,
                margin: stats.margin,
                profitPerUnit: stats.profitPerUnit,
                costPerUnit: stats.costPerUnit,
                sellPrice: stats.sellPrice
            });
            
            // Keep only last 20 entries
            if (window.appState.marginHistory[bp.id].length > 20) {
                window.appState.marginHistory[bp.id] = window.appState.marginHistory[bp.id].slice(-20);
            }
            
            saveToLocal();
            updateMarginChart();
        };

        function initMarginChart() {
            if(typeof Chart === 'undefined') return;
            
            const ctx = document.getElementById('marginChart').getContext('2d');
            const bp = getCurrentBP();
            const history = window.appState.marginHistory[bp.id] || [];
            
            const labels = history.map((entry, index) => 
                `Punto ${index + 1}`
            );
            
            const margins = history.map(entry => entry.margin);
            
            if(marginChart) marginChart.destroy();

            marginChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Margen %',
                        data: margins,
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#c9d1d9' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#8b949e' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { 
                                color: '#8b949e',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateMarginChart() {
            if (!marginChart) {
                if(window.appState.advancedMode) initMarginChart();
                return;
            }
            
            const bp = getCurrentBP();
            const history = window.appState.marginHistory[bp.id] || [];
            
            const labels = history.map((entry, index) => 
                `Punto ${index + 1}`
            );
            
            const margins = history.map(entry => entry.margin);
            
            marginChart.data.labels = labels;
            marginChart.data.datasets[0].data = margins;
            marginChart.update();
        }

        // --- CSV IMPORT ---
        window.previewCSV = (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim());
                
                currentCSVData = [];
                let previewHTML = '';
                
                lines.forEach((line, index) => {
                    const [name, price] = line.split(',').map(item => item.trim());
                    if (name && price && !isNaN(parseFloat(price))) {
                        currentCSVData.push({ name, price: parseFloat(price) });
                        previewHTML += `
                            <div class="csv-row p-2 flex justify-between">
                                <span class="text-gray-300">${name}</span>
                                <span class="text-green-400 font-mono">${parseFloat(price).toFixed(2)} ISK</span>
                            </div>
                        `;
                    }
                });
                
                if (currentCSVData.length > 0) {
                    document.getElementById('csvPreviewContent').innerHTML = previewHTML;
                    document.getElementById('csvPreview').classList.remove('hidden');
                } else {
                    alert('No se encontraron datos válidos en el CSV.');
                }
            };
            reader.readAsText(file);
        };

        window.importCSVData = () => {
            if (!currentCSVData) return;
            
            currentCSVData.forEach(item => {
                window.appState.prices[item.name] = item.price;
            });
            
            saveToLocal();
            renderPriceList();
            calculate();
            cancelCSVImport();
            alert(`${currentCSVData.length} precios importados desde CSV.`);
        };

        window.cancelCSVImport = () => {
            currentCSVData = null;
            document.getElementById('csvPreview').classList.add('hidden');
            document.getElementById('csvImport').value = '';
        };

        // --- COPY MATERIALS TO CLIPBOARD ---
        window.copyMaterialsToClipboard = () => {
            const prices = window.appState.prices;
            const names = Object.keys(prices).sort();
            let content = ""; 

            if (names.length > 0) {
                names.forEach(name => {
                    content += `${name}\n`;
                });
            }

            navigator.clipboard.writeText(content).then(() => {
                alert('Lista de materiales copiada al portapapeles.');
            }).catch(err => {
                console.error('Error al copiar: ', err);
                const textArea = document.createElement('textarea');
                textArea.value = content;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Lista de materiales copiada al portapapeles.');
            });
        };

        // --- SUMMARY SORTING ---
        window.sortSummary = (field) => {
            if (summarySort.field === field) {
                summarySort.ascending = !summarySort.ascending;
            } else {
                summarySort.field = field;
                summarySort.ascending = true;
            }
            renderSummaryTable();
        };

        function updateSortIcons() {
            const fields = ['name', 'tags', 'cost', 'price', 'profit', 'margin'];
            fields.forEach(f => {
                const icon = document.getElementById(`sort-icon-${f}`);
                if (icon) {
                    icon.innerHTML = '';
                    if (summarySort.field === f) {
                        icon.innerHTML = summarySort.ascending ? '↑' : '↓';
                    }
                }
            });
        }

        // --- TAG FILTERING ---
        function updateTagFilter() {
            const filter = document.getElementById('tagFilter');
            if (!filter) return;
            
            // Collect all unique tags
            const allTags = new Set();
            window.appState.blueprints.forEach(bp => {
                if (bp.tags) {
                    bp.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            // Keep existing selection
            const currentValue = filter.value;
            filter.innerHTML = '<option value="">Todas</option>';
            
            Array.from(allTags).sort().forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                filter.appendChild(option);
            });
            
            // Restore selection
            filter.value = currentValue;
        }

        window.filterSummaryByTag = () => {
            renderSummaryTable();
        };

        // --- NEW: SELECT BLUEPRINT HELPER ---
        window.selectBlueprintAndSwitch = (id) => {
            switchBlueprint(id);
            switchView('calculator');
        };

        // Helper: Pure calculation for non-active blueprints
        function getBlueprintStats(bp) {
            const runs = 1; // Standardize to 1 run for unit comparison
            const tax = window.appState.tax || 0;
            
            let totalMatCost = 0;
            bp.materials.forEach(mat => {
                const meFactor = 1 - ((bp.me || 0) / 100);
                const structFactor = 1 - ((bp.structure || 0) / 100);
                
                // Formula: Per run calculation to match main window logic
                let totalBase = mat.qty * runs;
                // Use TOTAL rounding to save materials (Standard behavior)
                // Note: For unit cost display, we assume 1 run, but ideally we'd use total runs config.
                // Since this is summary, we assume optimal (1 run calc) or simply unit price.
                // To match calculate():
                let totalReq = Math.max(runs, Math.ceil(totalBase * meFactor * structFactor));
                
                const price = window.appState.prices[mat.name] || 0;
                totalMatCost += totalReq * price;
            });

            const installCost = bp.installCost || 0;
            const totalJobCost = totalMatCost + installCost;
            const totalProduced = (bp.yield || 1) * runs;
            const costPerUnit = totalJobCost / totalProduced;
            
            const sellPrice = bp.sellPrice || 0;
            const netSell = sellPrice * (1 - (tax / 100));
            const profitPerUnit = netSell - costPerUnit;
            const margin = sellPrice > 0 ? (profitPerUnit / sellPrice) * 100 : 0;

            return { profitPerUnit, margin, costPerUnit, sellPrice, netSell, totalMatCost };
        }

        window.renderSummaryTable = () => {
            const tbody = document.getElementById('summaryTable');
            tbody.innerHTML = '';

            const bps = window.appState.blueprints || [];
            if (bps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No hay blueprints registrados.</td></tr>';
                return;
            }

            // Filter by tag if selected
            const tagFilter = document.getElementById('tagFilter').value;
            let filteredBPs = bps;
            if (tagFilter) {
                filteredBPs = bps.filter(bp => 
                    bp.tags && bp.tags.includes(tagFilter)
                );
            }

            // Sort
            filteredBPs.sort((a, b) => {
                const statsA = getBlueprintStats(a);
                const statsB = getBlueprintStats(b);
                let aVal, bVal;
                
                switch (summarySort.field) {
                    case 'name':
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        break;
                    case 'tags':
                        aVal = (a.tags || []).join(', ').toLowerCase();
                        bVal = (b.tags || []).join(', ').toLowerCase();
                        break;
                    case 'cost':
                        aVal = statsA.costPerUnit;
                        bVal = statsB.costPerUnit;
                        break;
                    case 'price':
                        aVal = statsA.sellPrice;
                        bVal = statsB.sellPrice;
                        break;
                    case 'profit':
                        aVal = statsA.profitPerUnit;
                        bVal = statsB.profitPerUnit;
                        break;
                    case 'margin':
                        aVal = statsA.margin;
                        bVal = statsB.margin;
                        break;
                    default:
                        aVal = a.name;
                        bVal = b.name;
                }
                
                if (typeof aVal === 'string') {
                    return summarySort.ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return summarySort.ascending ? aVal - bVal : bVal - aVal;
                }
            });

            // Render
            filteredBPs.forEach(bp => {
                const stats = getBlueprintStats(bp);
                const isProfitable = stats.profitPerUnit >= 0;
                const profitClass = isProfitable ? 'text-green-400' : 'text-red-500';
                
                const tr = document.createElement('tr');
                tr.className = "summary-row transition border-b border-gray-800";
                
                const fmt = (num) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);

                // Format tags
                const tagsHTML = (bp.tags || []).map(tag => 
                    `<span class="tag text-xs px-2 py-1 rounded mr-1">${tag}</span>`
                ).join('');

                tr.innerHTML = `
                    <td class="p-3">
                        <button onclick="selectBlueprintAndSwitch('${bp.id}')" class="font-bold text-blue-400 hover:text-white hover:underline text-left">
                            ${bp.name}
                        </button>
                    </td>
                    <td class="p-3 text-right">
                        <div class="flex flex-wrap gap-1 justify-end">
                            ${tagsHTML || '<span class="text-gray-500 text-xs">sin etiquetas</span>'}
                        </div>
                    </td>
                    <td class="p-3 text-right font-mono text-gray-400">${fmt(stats.costPerUnit)}</td>
                    <td class="p-3 text-right font-mono text-gray-300">${fmt(stats.sellPrice)}</td>
                    <td class="p-3 text-right font-mono font-bold ${profitClass}">${fmt(stats.profitPerUnit)}</td>
                    <td class="p-3 text-right font-mono text-sm ${profitClass}">${stats.margin.toFixed(1)}%</td>
                `;
                tbody.appendChild(tr);
            });

            updateSortIcons();
        };

        // --- DETAILED BREAKDOWN (UPDATED TO SHOW TOTALS) ---
        function renderDetailedBreakdown() {
            if (!window.appState.advancedMode) return;
            
            const tbody = document.getElementById('detailedBreakdownTable');
            tbody.innerHTML = '';
            
            const bp = getCurrentBP();
            const runs = parseInt(document.getElementById('jobRuns').value) || 1;
            
            bp.materials.forEach((mat, index) => {
                const price = window.appState.prices[mat.name] || 0;
                const meFactor = 1 - (bp.me / 100);
                const structFactor = 1 - (bp.structure / 100);
                
                // Calculate TOTAL values for the job
                let totalBase = mat.qty * runs;
                let totalReq = Math.max(runs, Math.ceil(totalBase * meFactor * structFactor));
                let totalCost = totalReq * price;
                let reductionPercent = ((totalBase - totalReq) / totalBase) * 100;
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 text-xs";
                tr.innerHTML = `
                    <td class="py-2 pl-2 font-medium text-gray-300">${mat.name}</td>
                    <td class="text-center font-mono text-gray-400">${totalBase.toLocaleString()}</td>
                    <td class="text-center font-mono text-blue-400">${(meFactor * 100).toFixed(1)}%</td>
                    <td class="text-center font-mono text-blue-400">${(structFactor * 100).toFixed(1)}%</td>
                    <td class="text-center font-mono text-white font-bold">${totalReq.toLocaleString()}</td>
                    <td class="text-center font-mono ${reductionPercent > 0 ? 'text-green-400' : 'text-gray-500'}">
                        ${reductionPercent > 0 ? `-${reductionPercent.toFixed(1)}%` : '0%'}
                    </td>
                    <td class="text-right font-mono text-gray-400">${totalCost.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- AUTOCOMPLETE LOGIC ---
        window.updateMaterialDatalist = () => {
            const datalist = document.getElementById('materialSuggestions');
            if (!datalist) return;
            datalist.innerHTML = '';
            
            const knownMaterials = Object.keys(window.appState.prices || {}).sort();
            
            knownMaterials.forEach(mat => {
                const opt = document.createElement('option');
                opt.value = mat;
                datalist.appendChild(opt);
            });
        };

        // --- PRICE LOCK LOGIC ---
        window.togglePriceLock = (matName) => {
            if (!window.appState.lockedPrices) window.appState.lockedPrices = {};
            
            const isLocked = window.appState.lockedPrices[matName];
            window.appState.lockedPrices[matName] = !isLocked;
            
            saveToLocal();
            renderPriceList();
        };

        // --- PRICE LIST LOGIC ---
        window.renderPriceList = () => {
            const tbody = document.getElementById('globalPriceTable');
            tbody.innerHTML = '';

            const allMaterials = new Set(Object.keys(window.appState.prices));
            window.appState.blueprints.forEach(bp => {
                bp.materials.forEach(m => allMaterials.add(m.name));
            });

            const sortedMats = Array.from(allMaterials).sort();

            if (sortedMats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">No hay materiales registrados.</td></tr>';
                return;
            }

            sortedMats.forEach(matName => {
                const price = window.appState.prices[matName] || 0;
                const usedInCount = window.appState.blueprints.filter(bp => 
                    bp.materials.some(m => m.name === matName)
                ).length;
                
                // Lock Logic
                const isLocked = window.appState.lockedPrices && window.appState.lockedPrices[matName];
                const lockIcon = isLocked ? 'fa-lock' : 'fa-lock-open';
                const lockColor = isLocked ? 'text-red-500 hover:text-red-400' : 'text-gray-500 hover:text-white';
                const inputState = isLocked ? 'disabled class="eve-input w-32 rounded px-2 py-1 text-right text-sm font-bold text-white opacity-50 cursor-not-allowed"' : 'class="eve-input w-32 rounded px-2 py-1 text-right text-sm font-bold text-white"';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition";
                tr.innerHTML = `
                    <td class="p-3 font-medium text-gray-300">${matName}</td>
                    <td class="p-3 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <input type="number" step="0.01" value="${price}" 
                                onchange="updateGlobalPrice('${matName}', this.value)"
                                ${inputState}>
                            <button onclick="togglePriceLock('${matName}')" class="${lockColor} transition px-2" title="${isLocked ? 'Desbloquear' : 'Bloquear'}">
                                <i class="fa-solid ${lockIcon}"></i>
                            </button>
                        </div>
                    </td>
                    <td class="p-3 text-right text-gray-500 font-mono">${usedInCount} BPs</td>
                `;
                tbody.appendChild(tr);
            });
        };

        // --- EXPORT TXT LOGIC ---
        window.exportPriceListToTxt = () => {
            const prices = window.appState.prices;
            const names = Object.keys(prices).sort();
            let content = ""; 

            if (names.length > 0) {
                names.forEach(name => {
                    content += `${name}\n`;
                });
            }

            const blob = new Blob([content], { type: 'text/plain' });
            downloadBlob(blob, `nombres_materiales_eve_${getDateStr()}.txt`);
        };

        // --- EXPORT / IMPORT LOGIC ---
        window.exportData = () => {
            const dataStr = JSON.stringify(window.appState, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            downloadBlob(blob, `eve_data_${getDateStr()}.json`);
        };

        window.downloadFullApp = () => {
            let htmlContent = document.documentElement.outerHTML;
            const dataString = `window.appState = ${JSON.stringify(window.appState, null, 4)};`;
            const regex = /\/\/\s*--\s*DATA_MARKER_START\s*--[\s\S]*?\/\/\s*--\s*DATA_MARKER_END\s*--/;
            
            if (regex.test(htmlContent)) {
                htmlContent = htmlContent.replace(regex, `// -- DATA_MARKER_START --\n        ${dataString}\n        // -- DATA_MARKER_END --`);
                const blob = new Blob([htmlContent], { type: 'text/html' });
                downloadBlob(blob, `EVE_Factory_App_${getDateStr()}.html`);
                alert('App completa descargada. Contiene tus datos actuales.');
            } else {
                alert('Error al generar la app.');
            }
        };

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function getDateStr() {
            return new Date().toISOString().split('T')[0];
        }

        window.importData = (input) => {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.blueprints && data.prices) {
                        if (confirm('¿Cargar datos? Se sobrescribirá la configuración actual.')) {
                            window.appState = data;
                            if (typeof window.appState.tax === 'undefined') window.appState.tax = 3.6;
                            
                            saveToLocal();
                            renderApp();
                            loadCurrentBlueprintInUI();
                            updateMaterialDatalist(); 
                            // Refresh view if needed
                            const activeTab = document.querySelector('.tab-btn.active');
                            if (activeTab.id === 'tab-prices') renderPriceList();
                            if (activeTab.id === 'tab-summary') renderSummaryTable();

                            alert('Datos cargados correctamente.');
                        }
                    } else {
                        alert('Archivo inválido.');
                    }
                } catch (err) {
                    alert('Error al leer JSON.');
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        };

        // --- DATA PERSISTENCE ---
        window.triggerSave = () => {
            calculate();
            updateStatus('saving');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveToLocal();
            }, 1000);
        };

        function saveToLocal() {
            localStorage.setItem('eve_factory_local', JSON.stringify(window.appState));
            updateStatus('saved');
        }

        // --- UI & LOGIC ---
        function updateStatus(status) {
            const dot = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            dot.className = 'status-dot';
            
            if (status === 'saved') {
                dot.classList.add('status-saved');
                text.innerText = 'Guardado Local';
                text.className = 'text-gray-400 text-xs font-mono uppercase tracking-widest';
            } else if (status === 'saving') {
                dot.classList.add('status-saving');
                text.innerText = 'Guardando...';
                text.className = 'text-yellow-500 text-xs font-mono uppercase tracking-widest';
            }
        }

        function getCurrentBP() {
            return window.appState.blueprints.find(bp => bp.id === window.appState.currentId) || window.appState.blueprints[0];
        }

        function updateBlueprintSelector() {
            const select = document.getElementById('blueprintSelector');
            select.innerHTML = '';
            window.appState.blueprints.forEach(bp => {
                const opt = document.createElement('option');
                opt.value = bp.id;
                opt.innerText = bp.name;
                opt.className = "bg-gray-800 text-white";
                select.appendChild(opt);
            });
            select.value = window.appState.currentId;
        }

        // --- BLUEPRINT SWITCHING ---
        window.switchBlueprint = (id) => {
            // 1. Save state of current BP (old ID)
            calculate(); 
            
            // 2. Switch the active ID
            window.appState.currentId = id;

            // 3. FORCE UPDATE THE DROPDOWN VISUAL TO MATCH NEW ID
            const selector = document.getElementById('blueprintSelector');
            if (selector) selector.value = id;

            // 4. Update the UI inputs with the *new* blueprint's values
            loadCurrentBlueprintInUI();
            
            // 5. Update chart if advanced mode
            if (window.appState.advancedMode && marginChart) {
                updateMarginChart();
            }
            
            // 6. Save
            saveToLocal();
        };

        window.createNewBlueprint = () => {
            const name = prompt("Nombre del nuevo Blueprint:");
            if (!name) return;
            
            calculate();
            
            const newId = 'bp_' + Date.now();
            window.appState.blueprints.push({
                id: newId, 
                name, 
                yield: 1, 
                me: 0, 
                structure: 0.0,
                installCost: 1000, 
                sellPrice: 0, 
                tags: [],
                materials: []
            });
            window.appState.currentId = newId;
            
            saveToLocal();
            updateBlueprintSelector();
            loadCurrentBlueprintInUI();
        };

        window.deleteCurrentBlueprint = () => {
            if (window.appState.blueprints.length <= 1) return alert("Mínimo 1 blueprint.");
            if (!confirm("¿Borrar blueprint actual?")) return;
            
            window.appState.blueprints = window.appState.blueprints.filter(bp => bp.id !== window.appState.currentId);
            window.appState.currentId = window.appState.blueprints[0].id;
            
            saveToLocal();
            updateBlueprintSelector();
            loadCurrentBlueprintInUI();
        };

        window.addMaterialFromInput = () => {
            const nameInput = document.getElementById('newMatName');
            const name = nameInput.value.trim();
            const qty = parseInt(document.getElementById('newMatQty').value);
            if (!name || isNaN(qty)) return;
            
            const bp = getCurrentBP();
            bp.materials.push({ name, qty });
            if (window.appState.prices[name] === undefined) {
                window.appState.prices[name] = 0;
                updateMaterialDatalist(); 
            }
            
            saveToLocal();
            renderMaterialsTable();
            calculate();
            nameInput.value = '';
            document.getElementById('newMatQty').value = '';
        };

        window.removeMaterial = (index) => {
            getCurrentBP().materials.splice(index, 1);
            saveToLocal();
            renderMaterialsTable();
            calculate();
        };

        function loadCurrentBlueprintInUI() {
            const bp = getCurrentBP();
            document.getElementById('meLevel').value = bp.me;
            document.getElementById('baseYield').value = bp.yield;
            document.getElementById('structureBonus').value = bp.structure;
            document.getElementById('installCost').value = bp.installCost;
            document.getElementById('sellPrice').value = bp.sellPrice;
            document.getElementById('salesTax').value = window.appState.tax;
            document.getElementById('jobRuns').value = 1;
            document.getElementById('tags').value = bp.tags ? bp.tags.join(', ') : '';
            renderMaterialsTable();
            calculate();
            
            if (window.appState.advancedMode) {
                renderDetailedBreakdown();
            }
        }

        // --- RENDER MATERIALS TABLE ---
        function renderMaterialsTable() {
            const bp = getCurrentBP();
            const tbody = document.getElementById('materialsTable');
            tbody.innerHTML = '';
            
            bp.materials.forEach((mat, index) => {
                const price = window.appState.prices[mat.name] || 0;
                
                // Check lock status
                const isLocked = window.appState.lockedPrices && window.appState.lockedPrices[mat.name];
                const inputState = isLocked 
                    ? 'disabled class="eve-input w-24 rounded px-2 py-1 text-right text-xs opacity-50 cursor-not-allowed" title="Precio bloqueado en Gestión de Precios"' 
                    : 'class="eve-input w-24 rounded px-2 py-1 text-right text-xs"';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 group transition text-xs md:text-sm";
                tr.innerHTML = `
                    <td class="py-2 pl-2 font-medium text-gray-300">${mat.name}</td>
                    <td class="text-center">
                        <input type="number" value="${mat.qty}" onchange="updateMatBaseQty(${index}, this.value)"
                           class="bg-gray-800 border border-gray-700 rounded w-16 text-center text-xs focus:border-blue-500 outline-none text-gray-400">
                    </td>
                    <td class="text-center font-bold text-white font-mono" id="req-qty-${index}">0</td>
                    <td class="text-right">
                        <input type="number" step="0.01" value="${price}" onchange="updateGlobalPrice('${mat.name}', this.value)"
                            ${inputState}>
                    </td>
                    <td class="text-right text-gray-400 font-mono" id="row-cost-${index}">0.00</td>
                    <td class="text-center">
                        <button onclick="removeMaterial(${index})" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.renderApp = () => {
            updateBlueprintSelector();
        };

        window.updateMatBaseQty = (idx, val) => {
            getCurrentBP().materials[idx].qty = parseFloat(val);
            triggerSave();
        };

        window.updateGlobalPrice = (name, val) => {
            window.appState.prices[name] = parseFloat(val);
            triggerSave();
        };

        // --- UPDATED CALCULATE FUNCTION ---
        window.calculate = () => {
            const bp = getCurrentBP();
            
            // Save tags
            const tagsInput = document.getElementById('tags').value;
            bp.tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            bp.me = parseInt(document.getElementById('meLevel').value) || 0;
            bp.yield = parseInt(document.getElementById('baseYield').value) || 1;
            bp.structure = parseFloat(document.getElementById('structureBonus').value) || 0;
            bp.installCost = parseFloat(document.getElementById('installCost').value) || 0;
            bp.sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            window.appState.tax = parseFloat(document.getElementById('salesTax').value) || 0;
            
            const runs = parseInt(document.getElementById('jobRuns').value) || 1;
            let totalMatCost = 0;

            bp.materials.forEach((mat, index) => {
                const meFactor = 1 - (bp.me / 100);
                const structFactor = 1 - (bp.structure / 100);
                
                // CORRECT FORMULA: Round up based on TOTAL job quantity, not per run
                // Total Requirement = Max(Runs, Ceil(BaseQty * Runs * ME_Modifier * Structure_Modifier))
                
                let totalBase = mat.qty * runs;
                let totalReq = Math.max(runs, Math.ceil(totalBase * meFactor * structFactor));
                
                const cost = totalReq * (window.appState.prices[mat.name] || 0);
                totalMatCost += cost;

                const reqEl = document.getElementById(`req-qty-${index}`);
                const costEl = document.getElementById(`row-cost-${index}`);
                if (reqEl) reqEl.innerText = totalReq.toLocaleString();
                if (costEl) costEl.innerText = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2 }).format(cost);
            });

            const totalJobCost = totalMatCost + bp.installCost;
            const totalProduced = bp.yield * runs;
            const costPerUnit = totalJobCost / totalProduced;
            
            const netSell = bp.sellPrice * (1 - (window.appState.tax / 100));
            const profitPerUnit = netSell - costPerUnit;
            const totalProfit = profitPerUnit * totalProduced;
            const margin = bp.sellPrice > 0 ? (profitPerUnit / bp.sellPrice) * 100 : 0;

            document.getElementById('totalMatCost').innerText = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2 }).format(totalMatCost);
            document.getElementById('costPerUnit').innerText = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2 }).format(costPerUnit);
            document.getElementById('netSellPriceDisplay').innerText = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2 }).format(netSell);
            document.getElementById('displayTotalRuns').innerText = runs;

            const profitEl = document.getElementById('profitPerUnit');
            profitEl.innerText = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2 }).format(profitPerUnit);
            profitEl.className = `text-2xl font-bold stat-value truncate ${profitPerUnit >= 0 ? 'text-green-400' : 'text-red-500'}`;
            
            const jobEl = document.getElementById('totalJobProfit');
            jobEl.innerText = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2 }).format(totalProfit);
            jobEl.className = `text-2xl font-bold stat-value truncate ${totalProfit >= 0 ? 'text-green-400' : 'text-red-500'}`;

            const marginEl = document.getElementById('marginPercent');
            marginEl.innerText = margin.toFixed(1) + '%';
            marginEl.className = margin > 0 ? 'text-green-400' : 'text-red-500';
            
            // Update detailed breakdown if advanced mode
            if (window.appState.advancedMode) {
                renderDetailedBreakdown();
            }
        };

        initApp();
    </script>
</body>
</html>
